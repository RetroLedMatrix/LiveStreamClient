//
// Created by marco on 15/11/2024.
//

#include <iostream>
#include <sstream>
#include "../../includes/WebSocketClient.h"
#include "../../includes/enums/MessageFormat.h"

WebSocketClient::WebSocketClient(const std::string &address, const std::string &port, const std::string &path)
    : connection(address, port, path) {
}

WebSocketClient::~WebSocketClient() {
    WSACleanup();
}

void WebSocketClient::run() {
    WSADATA wsaData;
    if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) {
        std::cerr << "WSAStartup failed" << std::endl;
        return;
    }

    if (!connection.connect()) {
        std::cerr << "Failed to connect to WebSocket server" << std::endl;
        return;
    }

    std::cout << "Type 'exit' to terminate" << std::endl;
    std::string userInput;
    while (true) {
        std::cout << ">>";
        std::getline(std::cin, userInput);

        if (userInput == "exit") {
            break;
        }

        std::istringstream iss(userInput);
        std::string commandStr;
        std::string argument;
        iss >> commandStr >> argument;

        MessageFormat format = stringToMessageFormat(commandStr);

        switch (format) {
            case ALL_PIXELS:
                connection.sendMessage(
                    R"({"type":"allpixels","data":"00001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333"})");
                break;
            case RESET:
                connection.sendMessage(R"({"type":"clear"})");
                break;
            default:
                std::cout << "Unknown command" << std::endl;
                break;
        }

        // We don't receive any messages from the matrix
        // std::string response = connection.receiveMessage();
        // std::cout << "Received: " << response << std::endl;
    }

    connection.closeConnection();
}
