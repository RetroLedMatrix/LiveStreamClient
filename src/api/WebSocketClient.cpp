//
// Created by marco on 15/11/2024.
//

#include <iostream>
#include <sstream>
#include <thread>
#include <csignal>
#include "../../includes/BitmapConverter.h"
#include "../../includes/api/WebSocketClient.h"
#include "../../includes/enums/Commands.h"
#include "../../includes/BrainsBehindScreenshot.h"

WebSocketClient::WebSocketClient(const std::string &address, const std::string &port, const std::string &path)
    : connection(address, port, path) {
}

WebSocketClient::~WebSocketClient() {
    WSACleanup();
}

void WebSocketClient::testAllPixels() const {
    connection.sendMessage(
        R"({"type":"allpixels","data":"00001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333000011112222333300001111222233330000111122223333"})");
}

void WebSocketClient::reset() const {
    connection.sendMessage(R"({"type":"clear"})");
}

void WebSocketClient::saveScreenShot() {
    std::wstring filename = L"screenshot.bmp";

    if (ScreenCapture::CaptureScreen(filename)) {
        std::wcout << L"Screenshot saved to " << filename << std::endl;
    } else {
        std::wcerr << L"Failed to capture the screen." << std::endl;
    }
}

void WebSocketClient::takeAndSendScreenShot() const {
    int width, height;

    HBITMAP hBitmap = ScreenCapture::CaptureScreenBitmap(width, height);
    if (hBitmap == nullptr) {
        std::cerr << "Screen capture failed." << std::endl;
        return;
    }

    const auto pixels = BitmapConverter::HBitmapToRGB(hBitmap, width, height);
    const auto resizedPixels = BitmapConverter::ResizeImage(pixels, width, height, MATRIX_WIDTH, MATRIX_HEIGHT);
    const auto categorizedPixels = BitmapConverter::CategorizePixels(resizedPixels, MATRIX_WIDTH, MATRIX_HEIGHT);

    const std::string pixelString = BitmapConverter::PixelsToString(categorizedPixels);

    connection.sendMessage(R"({"type":"allpixels","data":")" + pixelString + R"("})");

    DeleteObject(hBitmap);
}

void WebSocketClient::signalHandler(const int signum) {
    std::cout << "\nInterrupt signal (" << signum << ") received. Stopping stream..." << std::endl;
    keepRunning = false;
}

[[noreturn]] void WebSocketClient::startStream() const {
    std::signal(SIGINT, signalHandler);
    std::cout << "Press Ctrl+C to stop the stream..." << std::endl;

    while (keepRunning) {
        takeAndSendScreenShot();
        std::this_thread::sleep_for(std::chrono::milliseconds(20)); // 50fps
    }
}

void WebSocketClient::run() {
    WSADATA wsaData;
    if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) {
        std::cerr << "WSAStartup failed" << std::endl;
        return;
    }

    if (!connection.connect()) {
        std::cerr << "Failed to connect to WebSocket server" << std::endl;
        return;
    }

    printHelp();

    std::string input;
    bool running = true;

    while (running) {
        std::cout << ">>";
        std::getline(std::cin, input);

        if (input.empty()) {
            continue;
        }

        std::istringstream iss(input);
        std::string commandStr;
        std::string argument;
        iss >> commandStr >> argument;

        Commands command = stringToCommand(commandStr);

        switch (command) {
            case ALL:
                testAllPixels();
                break;
            case RESET:
                reset();
                break;
            case TAKE:
                takeAndSendScreenShot();
                break;
            case START:
                keepRunning = true;
                startStream();
                break; // we can interrupt with Ctrl+C, so we need that
            case SAVE:
                saveScreenShot();
                break;
            case HELP:
                printHelp();
                break;
            case EXIT:
                running = false;
                break;
            default:
                std::cout << "Unknown command" << std::endl;
                break;
        }

        // We don't receive any messages from the matrix
        // std::string response = connection.receiveMessage();
        // std::cout << "Received: " << response << std::endl;
    }

    connection.closeConnection();
}
